---
title: "Homelessness and Geographic Crosswalks"
format: html
---

```{r message = FALSE, echo=FALSE}
library(leaflet)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(scales)
library(sf)
# library(knitr)
# library(webshot2)

```

# Intro

[TODO: Build this out later]


# Background

## Annual Homelessness Assessment Report (AHAR)

```{r message = FALSE}
pit_df <- read.csv("data/pit_by_coc_concat.csv")

pit_by_year_df <- pit_df |> 
  group_by(Year) |>
  summarise(Overall.Homeless = sum(Overall.Homeless, na.rm = TRUE), 
            Sheltered.Total.Homeless = sum(Sheltered.Total.Homeless, na.rm = TRUE),
            Unsheltered.Homeless = sum(Unsheltered.Homeless, na.rm = TRUE)) |>
  gather(key="Count.Type", value = "Count", -Year)


cocs_2017 <- read_sf("data/CoC_GIS_NatlTerrDC_Shapefile_2017/FY17_CoC_National_Bnd.gdb", "FY17_CoC_National_Bnd") 

cocs_2017 <- cocs_2017 |>
  filter(!(ST %in% c("GU", "HI", "AK", "VI", "PR")))
cocs_2017 <- st_make_valid(cocs_2017)

cocs_2017 <- st_transform(cocs_2017, 4326)

pit_2017_df <- pit_df |>
  filter(Year == 2017) |>
  select(CoC.Number, CoC.Name, Overall.Homeless, Sheltered.Total.Homeless, Unsheltered.Homeless)

cocs_2017 <- cocs_2017 |> inner_join(pit_2017_df, by=join_by(COCNUM == CoC.Number))

cocs_2024 <- read_sf("data/CoC_GIS_National_Boundary_2024/CoC_GIS_National_Boundary.gdb", "FY24_CoC_National_Bnd") 

cocs_2024 <- cocs_2024 |>
  filter(!(ST %in% c("GU", "HI", "AK", "VI", "PR")))
cocs_2024 <- st_make_valid(cocs_2024)

cocs_2024 <- st_transform(cocs_2024, 4326)

pit_2024_df <- pit_df |>
  filter(Year == 2024) |>
  select(CoC.Number, CoC.Name, Overall.Homeless, Sheltered.Total.Homeless, Unsheltered.Homeless)

cocs_2024 <- cocs_2024 |> inner_join(pit_2024_df, by=join_by(COCNUM == CoC.Number))
```


In 2001, Congress directed the US Department of Housing and Urban Development (HUD) to assist local communities in gathering data on homeless populations across the country. The first Annual Homelessness Assessment Report (AHAR) was published in 2007, and has done so yearly ever since. 

Each year's report consist of two main datasets: Point-in-Time (PIT) counts, which track the total number of sheltered and unsheltered homeless individuals (in addition to other associated demographic data), and Housing Inventory Counts (HIC), which track the number of beds available to shelter homeless individuals. (TODO: Cite O'Flaherty, AHAR 2024) Of these, PIT counts are the ones we will be primarily focusing on in this report.

```{r}

ggplot(pit_by_year_df,aes(x=Year, y = Count, colour = Count.Type)) + 
  geom_line() +
  labs(title="Point-in-Time (PIT) Counts Over Time", x = "Year", y = NULL, colour = NULL) +
  scale_x_continuous(breaks = breaks_width(2)) +
  scale_y_continuous(label=label_number(scale = 1e-3, suffix = "k", big.mark = ","))


```

The basic geographic unit of the dataset is the Continuum of Care (CoC). AHAR defines a CoC as "local planning bodies responsible for coordinating the full range of homelessness services in a geographic area, which may cover a city, county, metropolitan area, or an entire state." (TODO: Cite AHAR 2024 pt 1)

```{r message=FALSE}

## Commenting this out and replacing with a still image of resulting map for performance reasons

# cuts <- as.integer(quantile(cocs_2024$Overall.Homeless, probs = seq(0,1,(1/6))))
# 
# zoomLevel <- 4
# 
# pal <- colorBin(palette = "Blues", domain = cocs_2024$Overall.Homeless, bins = cuts)
# leaflet(cocs_2024, options = leafletOptions(zoomControl = FALSE, minZoom = zoomLevel, maxZoom = zoomLevel)) |>
#   setMaxBounds(lng1 = -125.0011, lat1 = 24.9493, lng2 = -66.9326, lat2 = 49.5904) |>
#   # setView(lng = -103.771556, lat = 44.967243, zoom = zoomLevel) |>
#   addProviderTiles("Esri.WorldStreetMap") |>
#   addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1, color = ~pal(Overall.Homeless)) |>
#   addLegend("bottomright", pal = pal, values = ~Overall.Homeless,
#     title = "PIT Count",
#     opacity = 1
#   )

```

![PIT Counts, 2024](images/pit_count_2024.jpg)

# The Crosswalk

## Correlating AHAR Data with Census Data

Because CoC very boundaries are so irregular, it is difficult to obtain measurements for them that are not directly gathered in the AHAR report. Even measurements as basic as total population count are hard to come by at the CoC level. Since CoCs vary so widely in size, this makes it difficult to put PIT counts into perspective.

Byrne et al (TODO: CITE) were the first to attempt to solve this problem, by creating a geographic crosswalk to match counties with CoCs. The code that performs the crosswalk can be found here (link to github: https://github.com/tomhbyrne/HUD-CoC-Geography-Crosswalk) (TODO: CITE). 

### How the crosswalk works

The tricky thing about matching CoCs and counties is that it is not a simple 1-to-1 relationship, or even a 1-to-many relationship. Some CoCs contain multiple counties, while some counties contain multiple CoCs. To match them, Byrne et al used census tract centroids.

Census tracts are a geographic subdivision of counties, determined by the Census Bureau for the purposes of presenting data (TODO: CITE) (Sources: https://www.census.gov/glossary/?term=Census+tract, https://www.census.gov/content/dam/Census/library/publications/2020/acs/acs_geography_handbook_2020.pdf). Byrne et al start their crosswalk by matching census tracts with CoCs. They do this by calculating the centroid of each tract and seeing which CoC it intersects with; in cases where the tract centroid is not contained with in the tract itself (e.g. if the tract is a crescent shape), then a random point within the polygon is used instead. 

```{r}
county_coc_match_2017_df <- read.csv("data/output_2017/county_coc_match.csv")

county_coc_match_2017_df

```

Once each tract has been matched with a CoC, Byrne et al then aggregate the data to the county level to determine the overall population, as well as what percentage of the county population is contained within a CoC. Thus, it becomes possible to map homeless rates to population numbers.

```{r}

coc_population_2017_df <- read.csv("data/output_2017/coc_population.csv")

coc_population_2017_df <- cocs_2017 |>
  inner_join(coc_population_2017_df, by = join_by(COCNUM == coc_number)) |>
  mutate(HomelessPer100K = (Overall.Homeless / total_population)*100000)
```

```{r message = FALSE, warning=FALSE}
# cuts <- as.integer(quantile(coc_population_2017_df$HomelessPer100K, probs = seq(0,1,(1/6)), na.rm = TRUE))
# 
# zoomLevel <- 4
# 
# pal <- colorBin(palette = "Blues", domain = coc_population_2017_df$HomelessPer100K, bins = cuts)
# leaflet(coc_population_2017_df, options = leafletOptions(zoomControl = FALSE, minZoom = zoomLevel, maxZoom = zoomLevel)) |>
#   setMaxBounds(lng1 = -125.0011, lat1 = 24.9493, lng2 = -66.9326, lat2 = 49.5904) |>
#   addProviderTiles("Esri.WorldStreetMap") |>
#   addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1, color = ~pal(HomelessPer100K)) |>
#   addLegend("bottomright", pal = pal, values = ~HomelessPer100K,
#     title = "PIT Count per 100k",
#     opacity = 1
#   )
```

![PIT Counts per 100k Population, 2017](images/pit_count_per_100k_2017.jpg)

### Updating the crosswalk to 2024

A lot has changed since then. (TODO: list some examples; new Census has been done, pandemic happened, homeless populations stopped decreasing & started increasing). Unfortunately, it is not possible to run Byrne et al's code as is on 2024 data. Three of the R packages it used (rgdal, maptools, and rgeos) were discontinued in 2022, and so significant rewriting was required. You can find my updated code here: (TODO: CITE https://github.com/emmafurth/HUD-CoC-Geography-Crosswalk).

My goal with the rewrite was two-fold: first, to reproduce Byrne et al's results using the same inputs, as identically as possible. Second, to then run the same code on 2024 data, and see what has changed in the last eight years.

### Reproducing 2017 Data

Below is a table comparing my 2017 CoC population numbers with Byrne et al's original results. Unfortunately, the results are not perfectly identical.

```{r}

coc_population_comparison_df <- read.csv("data/output_comparison/coc_population_COMPARISON.csv")

coc_population_comparison_df <- coc_population_comparison_df |>
  mutate(pop_diff = abs(total_population_DIFF))


coc_population_comparison_df <- coc_population_comparison_df |>
  mutate(pop_diff_bin = case_when(pop_diff == 0 ~ "0%",
                                  pop_diff < 1 ~ "0-1%",
                                  pop_diff < 5 ~ "1-5%",
                                  pop_diff < 10 ~ "5-10%",
                                  .default = ">10%")) |>
  mutate(pop_diff_bin = factor(pop_diff_bin, levels = c("0%", "0-1%", "1-5%", "5-10%", ">10%")))

ggplot(coc_population_comparison_df, aes(x=pop_diff_bin)) +
  geom_bar()+
  xlab("% Difference in Total Population")

  

```


Due to lack of time, I was not fully able to determine where the differences come from. What brief I analysis I had time for suggested that imprecision in the shapefile definitions may be a factor. For example: at the outset, the crosswalk is supposed to exclude census tracts that do not overlap any CoC, but I found a few instances where tracts that share a border with a CoC were erroneously identified as overlapping. Filtering these out was not a simple matter, however: I found other places where CoC boundaries are mostly coterminous with county/census tract boundaries, except for a few deviations that were clearly intentional.

```{r}
## TODO: include pictures of weird boundary overlaps in arcmap
```

On the whole, however, my population counts were quite close to Byrne's results. None were more than (TODO: insert % figure) different, and so I am comfortable using the results of this code for analysis. 

### 2024 Data

```{r}

coc_population_2024_df <- read.csv("data/output_2024/coc_population.csv")

coc_population_2024_df <- cocs_2024 |>
  inner_join(coc_population_2024_df, by = join_by(COCNUM == coc_number)) |>
  mutate(HomelessPer100K = (Overall.Homeless / total_population)*100000)

```

```{r message = FALSE, warning=FALSE}
# cuts_24 <- as.integer(quantile(coc_population_2024_df$HomelessPer100K, probs = seq(0,1,(1/6)), na.rm = TRUE))
# 
# zoomLevel <- 4
# 
# pal_24 <- colorBin(palette = "Blues", domain = coc_population_2024_df$HomelessPer100K, bins = cuts_24)
# 
# leaflet(coc_population_2024_df, options = leafletOptions(zoomControl = FALSE, minZoom = zoomLevel, maxZoom = zoomLevel)) |>
#   setMaxBounds(lng1 = -125.0011, lat1 = 24.9493, lng2 = -66.9326, lat2 = 49.5904) |>
#   addProviderTiles("Esri.WorldStreetMap") |>
#   addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1, color = ~pal_24(HomelessPer100K)) |>
#   addLegend("bottomright", pal = pal_24, values = ~HomelessPer100K,
#     title = "PIT Count per 100k",
#     opacity = 1
#   )

```

![PIT Counts per 100k Population, 2024](images/pit_count_per_100k_2024.jpg)

```{r}
# coc_gdb <- read_sf("data/output/coc_pop.gdb", "CoC_pop")
# 
# coc_gdb <- st_transform(coc_gdb, 4326)
# 
# cuts_change <- as.integer(quantile(coc_gdb$prop_unsheltered_homeless_change_pct, probs = seq(0,1,(1/6)), na.rm = TRUE))
# 
# zoomLevel <- 4
# 
# pal_change <- colorBin(palette = "plasma", domain = coc_gdb$HomelessPer100K, bins = cuts_change)
# 
# leaflet(coc_gdb, options = leafletOptions(zoomControl = FALSE, minZoom = zoomLevel, maxZoom = zoomLevel)) |>
#   setMaxBounds(lng1 = -125.0011, lat1 = 24.9493, lng2 = -66.9326, lat2 = 49.5904) |>
#   addProviderTiles("Esri.WorldStreetMap") |>
#   addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1, color = ~pal_change(prop_unsheltered_homeless_change_pct)) |>
#   addLegend("bottomright", pal = pal_change, values = ~prop_unsheltered_homeless_change_pct,
#     title = "% Change in PIT Count per 100k",
#     opacity = 1
#   )

```

![% Change in PIT Counts per 100k, 2017-2024](images/pit_count_per_100k__pct_change.jpg)